---
title: "analysis"
format: html
editor: source
---


```{r}
library(tidyverse)
library(readxl)
library(drc)
library(ggthemes)
library(broom)
```



```{r}
dt1 <- read_excel("data/seed_burial_dt.xlsx", sheet = "6 Months") %>% 
  janitor::clean_names() %>% 
  mutate_if(is_character, as_factor)

dt2 <- read_excel("data/seed_burial_dt.xlsx", sheet = "12 Months") %>% 
  janitor::clean_names() %>% 
  mutate_at(c("viable_seed_as_percent_of_original", "dormancy_level_in_the_seedlot_percent"),
            as.double) %>% 
  mutate_if(is_character, as_factor)

dt3 <- read_excel("data/seed_burial_dt.xlsx", sheet = "24 Months") %>% 
  janitor::clean_names() %>% 
  mutate_if(is_character, as_factor)

dt4 <- read_excel("data/seed_burial_dt.xlsx", sheet = "36 Months") %>% 
  janitor::clean_names() %>% 
  mutate(depth_cm = parse_number(depth_cm)) %>% 
  mutate_if(is_character, as_factor) 

dt5 <- read_excel("data/seed_burial_dt.xlsx", sheet = "36 Months") %>% 
  janitor::clean_names() %>% 
  mutate(depth_cm = parse_number(depth_cm)) %>% 
  mutate_if(is_character, as_factor)

dt6 <- read_excel("data/seed_burial_dt.xlsx", sheet = "48 Months") %>% 
  janitor::clean_names() %>% 
  mutate(depth_cm = parse_number(depth_cm)) %>%
  mutate_if(is_character, as_factor)

dt7 <- read_excel("data/seed_burial_dt.xlsx", sheet = "60 Months") %>% 
  janitor::clean_names() %>% 
  mutate_if(is_character, as_factor) %>% 
  mutate(germination_1_6_days = as.double(germination_1_6_days)) %>% 
  dplyr::select(-germination_1_6_days, -germination_2_12_days, -germination_3_20_days) %>% 
  rename(number_seeds_excavated = no_of_seeds_retreived,
         number_seed_germinated = number_seeds_germinated,
         number_dormant_seed_tz = number_dormant_seeds_tz) 
```





```{r}
dt1 %>% 
  bind_rows(dt2) %>% 
  bind_rows(dt3) %>% 
  bind_rows(dt4) %>% 
  bind_rows(dt5) %>% 
  bind_rows(dt6) %>% 
  bind_rows(dt7) %>% 
  mutate(location = case_when(
    location == "CS" ~ "College Station",
    location == "CC" ~ "Corpus Christi",
    location == "LUB" ~ "Lubbock",
    TRUE ~ as_factor(location)
  )) %>% 
  mutate(species = case_when(
    species == "WH" ~ "waterhemp",
    species == "Waterhemp" ~ "waterhemp",
    species == "PA" ~ "Palmer amaranth",
    species == "Palmer" ~ "Palmer amaranth",
    TRUE ~ as_factor(species)
  )) -> data
```


```{r}
data %>% 
 group_by(species, location, depth_cm, field_rep, number_seeds_buried) %>% 
 count() %>% 
 mutate(retrieval_time_months = 0) %>% 
 mutate(viable_seed_as_percent_of_original = 100) %>% 
 dplyr::select(-n) -> at_zero
```


```{r}
data %>% 
  bind_rows(at_zero) -> data1
```



```{r}
data1 %>% 
  ggplot(aes(x=retrieval_time_months, y=viable_seed_as_percent_of_original)) +
  geom_point() +
  facet_wrap(location ~ species)

ggsave("figures/raw_figure.png", width = 12, height = 7)
```






```{r}
#| warning: false
#| 
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.4(),
  curveid = interaction(species, location, depth_cm), data=data1) -> full_model

```

```{r}
#| warning: false
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.4(),
  curveid = interaction(species, location), data=data1) -> reduced_model
```


```{r}
anova(full_model, reduced_model)
```


```{r}
summary(full_model)
```




Lubbock

```{r}
data1 %>% filter(location=="Lubbock") -> lub_dt
```


```{r}
#| warning: false
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.3(),
  curveid = interaction(species, depth_cm), data=lub_dt) -> lub_full

```

```{r}
#| warning: false 
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.3(),
   data=lub_dt) -> lub_red1
```


```{r}
anova(lub_full, lub_red1)
```


```{r}
tidy(lub_red1)
```

```{r}
plot(lub_red1)
```

```{r}
#| warning: false
newdata <- expand.grid(retrieval_time_months=seq(0, 60, length=60))

broom:::augment.drc(lub_red1, newdata=newdata, conf.int = TRUE) -> pm_lub
```

```{r}
lub_dt %>% 
  ggplot(aes(x=retrieval_time_months, y=viable_seed_as_percent_of_original)) +
  geom_jitter(alpha = 0.1, color="#0072B2") +
  geom_line(data = pm_lub, aes(x = retrieval_time_months, y = .fitted), 
            size = 1.2, color="#0072B2") +
  geom_ribbon(data = pm_lub, mapping=aes(x = retrieval_time_months, y = .fitted, 
                                         ymin=.lower, ymax=.upper), 
              alpha=0.1, fill="#0072B2") +
  theme_foundation() +
  facet_grid(~location) +
  labs(x="Month after burial", y="Viable seed reduction (%)") +
  theme(strip.text = element_text(size=11,face="bold"))



ggsave("figures/Lubbock.png", width = 5, height = 5)
```

```{r}
tidy(lub_red1)
```


```{r}
ED(lub_red1, c(10,50,90), interval = "delta")
```


## College Station 


```{r}
data1 %>% filter(location=="College Station") -> cs_dt
```


```{r}
#| warning: false
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.3(),
  curveid = interaction(species, depth_cm), data=cs_dt) -> cs_full

```

```{r}
#| warning: false 
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.3(),
   curveid = species, data=cs_dt) -> cs_red1
```


```{r}
anova(cs_full, cs_red1)
```


```{r}
tidy(cs_red1)
```

```{r}
plot(cs_red1)
```


```{r}
#| warning: false 
newdata <- expand.grid(retrieval_time_months=seq(0, 60, length=60))

newdata1 <- tibble(species="Palmer amaranth", newdata)
newdata2 <- tibble(species="waterhemp", newdata)

nd = rbind(newdata1, newdata2)

broom:::augment.drc(cs_red1, newdata=nd, conf.int = TRUE) -> pm_cs

cs_dt$retrieval_time_months0 <- cs_dt$retrieval_time_months
cs_dt$retrieval_time_months0[cs_dt$retrieval_time_months0==0] <- 0.1
```
 


 

```{r}
cs_dt %>% 
  ggplot(aes(x=retrieval_time_months0, 
             y=viable_seed_as_percent_of_original)) +
#  coord_trans(x= "log") +
  geom_line(data = pm_cs, aes(x = retrieval_time_months, y = .fitted, 
                              color=species),
            size = 1.2) +
  geom_ribbon(data = pm_cs, mapping=aes(x = retrieval_time_months, y = .fitted, 
                                         ymin=.lower, ymax=.upper, fill=species), 
              alpha=0.1) +
  geom_jitter(aes(color=species), alpha=0.1) +
  theme_foundation() +
  scale_color_colorblind() +
  scale_fill_colorblind() +
  facet_grid(~location) +
  labs(x="Month after burial", 
       y="Viable seed reduction (%)",
       color="", fill="") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48, 60)) +
  theme(strip.text = element_text(size=11,face="bold"),
        legend.position = "bottom")



ggsave("figures/College Station.png", width = 5, height = 5)
```

```{r}
tidy(lub_red1)
```


```{r}
ED(lub_red1, c(10,50,90), interval = "delta")
```





## Corpus Christi 


```{r}
data1 %>% filter(location=="Corpus Christi") -> cc_dt
```


```{r}
#| warning: false
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.3(),
  curveid = interaction(species, depth_cm), data=cc_dt) -> cc_full

```

```{r}
#| warning: false 
drm(viable_seed_as_percent_of_original ~ retrieval_time_months, fct = W1.3(),
   curveid = species, data=cc_dt) -> cc_red1
```


```{r}
anova(cc_full, cc_red1)
```


```{r}
tidy(cc_red1)
```

```{r}
plot(cc_red1)
```


```{r}
#| warning: false 
newdata <- expand.grid(retrieval_time_months=seq(0, 60, length=60))

newdata1 <- tibble(species="Palmer amaranth", newdata)
newdata2 <- tibble(species="waterhemp", newdata)

nd = rbind(newdata1, newdata2)

broom:::augment.drc(cc_red1, newdata=nd, conf.int = TRUE) -> pm_cc
```
 


 

```{r}
cc_dt %>% 
  ggplot(aes(x=retrieval_time_months, 
             y=viable_seed_as_percent_of_original)) +
#  coord_trans(x= "log") +
  geom_line(data = pm_cc, aes(x = retrieval_time_months, y = .fitted, 
                              color=species),
            size = 1.2) +
  geom_ribbon(data = pm_cc, mapping=aes(x = retrieval_time_months, y = .fitted, 
                                         ymin=.lower, ymax=.upper, fill=species), 
              alpha=0.1) +
  geom_jitter(aes(color=species), alpha=0.1) +
  theme_foundation() +
  scale_color_colorblind() +
  scale_fill_colorblind() +
  facet_grid(~location) +
  labs(x="Month after burial", 
       y="Viable seed reduction (%)",
       color="", fill="") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48, 60)) +
  theme(strip.text = element_text(size=11,face="bold"),
        legend.position = "bottom")



ggsave("figures/Corpus Christi.png", width = 5, height = 5)
```

```{r}
tidy(cc_red1)
```


```{r}
ED(cc_red1, c(10,50,90), interval = "delta")
```





